<!doctype html>
<html>
<meta charset=utf-8>

<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
        crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <link href="css/animate.css" rel="stylesheet">
    <link href="css/colors.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <script src="js/vue.js"></script>
    <script src="js/colors.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
    <title>Schätz-App</title>
</head>

<body>
    <div id="app">
        <div class="container">
            <h1> Willkommen zur Schätz-App</h1>
            <br>
            <!--<div class="progress" style="height: 50px">-->
            <progress-bar v-for="size in sizes" :key="size.name" :name="size.name" :progress="size.progress" :color="size.color"></progress-bar>
            <!--</div>-->
            <reveal-button v-bind:users-connected="usersConnected" v-bind:users-voted="usersVoted"></reveal-button>
            <ul class="users list-group">
                <li class="list-group-item active" style="margin-top: 20px;">Connected Users:</li>
                <user v-for="user in users" :key="user.name" :name="user.name" :emoji="user.emoji" :value="user.value" :voted="user.voted"
                    :show-votes="showVotes"></user>
        </div>

        <modal state="open" :tickets="tickets" :base-url="baseUrl" :sizes="sizes" :room-code="roomCode"></modal>
    </div>
    </div>
</body>


<script type='text/javascript'>
    Vue.config.devtools = true;
    var socket = io();

    socket.on('user connected', function (user) {
        app.usersConnected++;
        Vue.set(app.users, user.name, { name: user.name, voted: false, value: "" });
        socket.emit("user can vote");
    })

    socket.on('user voted', function (vote) {
        Vue.set(app.users, vote.user.name, { name: vote.user.name, voted: true, value: vote.card_value });
        app.usersVoted++;
    })

    var app;
    window.onload = function () {
        app = new Vue({
            el: '#app',
            data: {
                roomCode: '12345',
                settings: {},
                progress: 25,
                users: {},
                showVotes: false,
                usersConnected: 0,
                usersVoted: 0,
                sizes: {},
                tickets: [
                    "5858",
                    "5625",
                    "1337"
                ],
                baseUrl: [
                    "https://issuetracking.bsh-sdd.com/browse/HCCDR-"
                ]
            }
        })
        app.$on('joinRoom', function (settings) {
            this.settings = settings;
            Vue.set(app.sizes, "Training", { name: "Training", color: colors.navy, progress: 0 });
            Vue.set(app.sizes, "Amateur", { name: "Amateur", color: colors.teal, progress: 0 });
            Vue.set(app.sizes, "Semi-Pro", { name: "Semi-Pro", color: colors.maroon, progress: 0 });
            Vue.set(app.sizes, "Pro", { name: "Pro", color: colors.yellow, progress: 0 });
            Vue.set(app.sizes, "World-Class", { name: "World-Class", color: colors.orange, progress: 0 });
            Vue.set(app.sizes, "Legendary", { name: "Legendary", color: colors.red, progress: 0 });
            socket.emit('room chef', settings.roomCode);
        })

        app.$on('revealVotes', function () {
            Object.keys(app.users).forEach(function (key) {
                var user = app.users[key];
                var currentProgress = app.sizes[user.value].progress;
                var currentColor = app.sizes[user.value].color;

                app.sizes[user.value].progress++;
            });

            Object.keys(app.sizes).forEach(function (key) {
                var size = app.sizes[key];
                if(size.progress > 0) {
                    var percent = (size.progress/(Object.keys(app.users).length)) * 100;
                    Vue.set(app.sizes, size.name, { name: size.name, color: size.color, progress: percent });
                }
            })

            this.showVotes = true;
        })


    }
    Vue.component('modal', {
        template: '#modal-template',
        data: function () {
            return {
                settings: {
                    baseUrl: this.baseUrl,
                    tickets: this.tickets,
                    roomCode: this.roomCode
                }
            }
        },
        props: ['baseUrl', 'tickets', 'sizes', 'roomCode'],
        methods: {
            updateRoomCode: function (value) {
                this.settings.roomCode = value;
            },
            show: function () {
                $('#myModal').modal('show');
            },
            joinRoom: function () {
                app.$emit('joinRoom', this.settings)
            }
        },
        mounted() {
            this.show();
        }
    })

    Vue.component('progress-bar', {
        template: '#progress-bar-template',
        props: ['name', 'color', 'progress'],
    })

    Vue.component('reveal-button', {
        template: '#reveal-button-template',
        props: ['usersConnected', 'usersVoted'],
        methods: {
            reveal: function () {
                app.$emit('revealVotes');
            }
        }
    })

    Vue.component('user', {
        template: '#user-template',
        props: {
            name: String,
            emoji: String,
            value: String,
            voted: Boolean,
            showVotes: Boolean
        }
    })
</script>

<script type="text/x-template" id="progress-bar-template">
    <div v-if="progress > 0" class="progress" style="height: 50px">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" v-bind:style="{'width': progress + '%', 'background-color': color}">
            <div>{{ name }} - {{ progress }}%</div>
        </div>
    </div>
</script>

<script type="text/x-template" id="user-template">
    <li class="list-group-item">
        {{ emoji }} {{ name }} 
        
        <template v-if="voted">
            <span><i class="fas fa-check-circle float-right" style="color: green;"></i></span>
        </template>
        <template v-if="!voted">
            <span><i class="fas fa-times-circle float-right" style="color: red;"></i></span>
        </template>
        <em v-if="showVotes" class="float-right pr-2">
            {{ value }}
        </em>
    </li>
</script>

<script type="text/x-template" id="reveal-button-template">

    <button v-if="usersConnected > 0 && usersVoted > 0 && usersConnected == usersVoted" v-on:click="reveal" type="button" class="btn btn-success mx-auto">Reveal</button>

</script>

<script type="text/x-template" id="ticket-template">
    <li class="list-group-item">
        <a v-bind:href="baseUrl + ticket">
    </li>
</script>

<script type="text/x-template" id="modal-template">
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Room Settings</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" role="form" id="settingsForm">
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="inputUrl">Room Code</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="inputUrl" placeholder="Room Code" v-bind:value="roomCode" v-on:blur="updateRoomCode($event.target.value)"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="inputUrl">Base-Url</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="inputUrl" placeholder="Base-Url (for tickets)" v-bind:value="baseUrl" />
                        </div>
                    </div>
                    <div class=" form-group ">
                        <label class="col-sm-2 control-label " for="inputTickets ">Tickets</label>
                        <div class="col-sm-10 ">
                            <input type="text " class="form-control " id="inputTickets " placeholder="Tickets (comma-separated)" v-bind:value="tickets" />
                        </div>
                    </div>
                    <!--<div class="form-group ">
                        <label class="col-sm-2 control-label " for="inputSizes ">Sizes</label>
                        <div class="col-sm-10 ">
                            <input type="text " class="form-control " id="inputSizes " placeholder="Ticket Sizes (comma-separated) " v-bind:value="sizes"/>
                        </div>
                    </div> -->
                </form>
            </div>
            <div class="modal-footer ">
                <button type="button" class="btn btn-success" data-dismiss="modal" v-on:click="joinRoom">Join Room</button>
            </div>
        </div>
    </div>
</div>
</div>
</script>