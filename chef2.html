<!doctype html>
<html>
<meta charset=utf-8>

<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
        crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <link href="css/animate.css" rel="stylesheet">
    <link href="css/colors.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <script src="js/vue.js"></script>
    <script src="js/colors.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
    <script src="https://unpkg.com/vuex@2.0.0"></script>
    <title>Sch√§tz-App</title>
</head>

<body>
    <div id="app">
        <div class="container">
            <h1> Welcome to room: {{ roomCode }} </h1>
            <!--<div style="display: none;">{{ state }}</div>-->
            <br>
            <!--<div class="progress" style="height: 50px">-->
            <!--</div>-->
            <div class="row">
                <div class="col-md-12">

                </div>
                <div class="cards col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <user-progress-bar :progress="store.state.usersConnected/store.state.usersConnected"></user-progress-bar>
                            <ul class="tickets list-group list-group-flush">
                                <progress-bar v-for="size in sizes" :key="size.name" :name="size.name" :progress="size.progress" :color="size.color" :state="state"></progress-bar>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <ul class="users list-group list-group-flush col-md-6">
                    <li class="list-group-item active" style="margin-top: 20px;">Connected Users:
                        <reveal-button v-bind:users-connected="usersConnected" v-bind:users-voted="usersVoted"></reveal-button>
                    </li>
                    <user v-for="user in users" :key="user.name" :name="user.name" :emoji="user.emoji" :value="user.value" :voted="user.voted"
                        :show-votes="showVotes"></user>
                </ul>
                <ul class="tickets list-group list-group-flush col-md-6">
                    <li class="list-group-item active" style="margin-top: 20px;">Tickets:
                        <next-button></next-button>
                        <reschaetz-button></reschaetz-button>
                        <export-button></export-button>
                    </li>
                    <ticket v-for="ticket in this.store.state.tickets" :key="ticket.id" :id="ticket.id" :vote="ticket.vote" :result="ticket.result"
                        :active-ticket="activeTicket" :base-url="store.state.baseUrl" :title="ticket.title"></ticket>
                </ul>
            </div>

            <div class="row">
                <ul class="old-tickets list-group list-group-flush col-md-12">
                    <li class="list-group-item active" style="margin-top: 20px;">Old Tickets:</li>
                    <ticket v-for="ticket in this.store.state.oldTickets" :key="ticket.id" :id="ticket.id" :vote="ticket.vote" :result="ticket.result"
                        :active-ticket="activeTicket" :base-url="store.state.baseUrl" :title="ticket.title"></ticket>
                </ul>
            </div>
        </div>

        <modal state="open" :base-url="baseUrl" :sizes="sizes" :room-code="roomCode" :regex="regex"></modal>
    </div>
    </div>
</body>


<script type='text/javascript'>
    Vue.config.devtools = true;
    var socket = io();

    socket.on('user connected', function (user) {
        store.commit("userConnected");
        Vue.set(app.users, user.name, { name: user.name, voted: false, value: "" });
        if (store.state.appState === "join") {
            socket.emit("user can vote", user);
        } else {
            socket.emit("user wait", user);
        }
    })

    socket.on('user disconnected', function (roomCode) {
        if (store.state.roomCode === roomCode) {
            store.commit("userDisconnected");
        }
    })

    socket.on('user voted', function (vote) {
        Vue.set(app.users, vote.user.name, { name: vote.user.name, voted: true, value: vote.card_value });
        store.commit("userVoted");
        if (store.state.usersVoted > 0 && store.state.usersConnected > 0 && store.state.usersVoted === store.state.usersConnected) {
            store.commit("setAppState", "can_reveal");
        }
    })

    window.onbeforeunload = function () {
        return 'Are you sure you want to leave?';
    };

    const store = new Vuex.Store({
        state: {
            count: 0,
            roomCode: "12345",
            appState: "setup",
            activeTicketIndex: -1,
            activeTicket: {},
            usersConnected: 0,
            usersVoted: 0,
            regex: '',
            tickets: [],
            baseUrl: "",
            oldTickets: []
        },
        mutations: {
            increment(state) {
                state.count++;
            },
            setAppState(state, appState) {
                state.appState = appState;
            },
            setRoomCode(state, roomCode) {
                state.roomCode = roomCode;
            },
            setBaseUrl(state, baseUrl) {
                state.baseUrl = baseUrl;
            },
            setRegex(state, regex) {
                state.regex = regex;
            },
            nextTicket(state) {
                state.activeTicketIndex++;
                if (state.activeTicketIndex >= state.tickets.length) {
                    alert("All done!")
                    state.appState = "done";
                    store.commit("addOldTickets", state.tickets);
                    localStorage.setItem("tickets", JSON.stringify(state.tickets));
                    socket.emit("user done", state.roomCode);
                } else {
                    state.activeTicket = state.tickets[state.activeTicketIndex]
                }
            },
            firstTicket(state) {
                state.activeTicketIndex = 0;
                state.activeTicket = state.tickets[state.activeTicketIndex]
            },
            userConnected(state) {
                state.usersConnected++;
            },
            userDisconnected(state) {
                if (state.usersConnected > 0) {
                    state.usersConnected--;
                }
            },
            userVoted(state) {
                state.usersVoted++;
            },
            resetVotes(state) {
                state.usersVoted = 0;
            },
            setTickets(state, tickets) {
                state.tickets = tickets;
            },
            setTicketResult(state, result) {
                var index = state.tickets.findIndex(function (element) {
                    return element.id === state.activeTicket.id;
                });
                state.tickets[index].result = result;
            },
            addOldTickets(state, oldTickets) {
                state.oldTickets = [...state.oldTickets, ...oldTickets];
                localStorage.setItem("oldTickets", JSON.stringify(state.oldTickets));
            },
            setOldTickets(state) {
                state.oldTickets = JSON.parse(localStorage.getItem('oldTickets'));
            }
        }
    })

    var app;
    window.onload = function () {

        if (localStorage.getItem('regex')) {
            store.commit('setRegex', localStorage.getItem('regex'));
        }

        if (localStorage.getItem('baseUrl')) {
            store.commit('setBaseUrl', localStorage.getItem('baseUrl'));
        }

        if (localStorage.getItem('tickets')) {
            store.commit('setTickets', JSON.parse(localStorage.getItem('tickets')));
        }

        if (localStorage.getItem('oldTickets')) {
            store.commit('setOldTickets', JSON.parse(localStorage.getItem('oldTickets')));
        }

        app = new Vue({
            el: '#app',
            data: {
                store,
                settings: {},
                progress: 25,
                users: {},
                showVotes: false,
                sizes: {},
                activeTicket: {},
            },
            watch: {
                state: function (state) {
                    if (this.store.state.appState === "join") {
                        Vue.set(app.sizes, "Training", { name: "Training", color: colors.blue, progress: 0 });
                        Vue.set(app.sizes, "Amateur", { name: "Amateur", color: colors.teal, progress: 0 });
                        Vue.set(app.sizes, "Semi-Pro", { name: "Semi-Pro", color: colors.green, progress: 0 });
                        Vue.set(app.sizes, "Pro", { name: "Pro", color: colors.yellow, progress: 0 });
                        Vue.set(app.sizes, "World-Class", { name: "World-Class", color: colors.orange, progress: 0 });
                        Vue.set(app.sizes, "Legendary", { name: "Legendary", color: colors.red, progress: 0 });
                    } else if (this.store.state.appState === "reset") {
                        Object.keys(app.sizes).forEach(function (key) {
                            var size = app.sizes[key];
                            Vue.set(app.sizes, size.name, { name: size.name, color: size.color, progress: 0 });
                        })

                        Object.keys(app.users).forEach(function (key) {
                            var user = app.users[key];
                            Vue.set(app.users, user.name, { name: user.name, voted: false, value: "" });
                        });

                        socket.emit('card reset', this.store.state.roomCode);
                        this.store.commit("resetVotes");
                        this.store.commit("setAppState", "join");
                        this.store.commit("nextTicket");
                    } else if (this.store.state.appState === "reschaetz") {
                        Object.keys(app.sizes).forEach(function (key) {
                            var size = app.sizes[key];
                            Vue.set(app.sizes, size.name, { name: size.name, color: size.color, progress: 0 });
                        })

                        Object.keys(app.users).forEach(function (key) {
                            var user = app.users[key];
                            Vue.set(app.users, user.name, { name: user.name, voted: false, value: "" });
                        });

                        socket.emit('card reset', this.store.state.roomCode);
                        this.store.commit("resetVotes");
                        this.store.commit("setAppState", "join");
                    } else if (this.store.state.appState === "done") {
                        socket.emit('done');
                    }
                }
            },
            computed: {
                state: function () {
                    return this.store.state.appState;
                },
                roomCode: function () {
                    return this.store.state.roomCode;
                },
                baseUrl: function () {
                    return this.store.state.baseUrl;
                },
                regex: function () {
                    return this.store.state.regex;
                },
                usersConnected: function () {
                    return this.store.state.usersConnected;
                },
                usersVoted: function () {
                    return this.store.state.usersVoted;
                },
            }
        })
        app.$on('joinRoom', function (settings) {
            this.settings = settings;
            Vue.set(app.sizes, "Training", { name: "Training", color: colors.navy, progress: 0 });
            Vue.set(app.sizes, "Amateur", { name: "Amateur", color: colors.teal, progress: 0 });
            Vue.set(app.sizes, "Semi-Pro", { name: "Semi-Pro", color: colors.maroon, progress: 0 });
            Vue.set(app.sizes, "Pro", { name: "Pro", color: colors.yellow, progress: 0 });
            Vue.set(app.sizes, "World-Class", { name: "World-Class", color: colors.orange, progress: 0 });
            Vue.set(app.sizes, "Legendary", { name: "Legendary", color: colors.red, progress: 0 });
            //this.store.commit("nextTicket");
        })

        app.$on('revealVotes', function () {
            Object.keys(app.users).forEach(function (key) {
                var user = app.users[key];
                var currentProgress = app.sizes[user.value].progress;
                var currentColor = app.sizes[user.value].color;

                app.sizes[user.value].progress++;
            });

            let result = ""
            let maxProgress = -1;
            Object.keys(app.sizes).forEach(function (key) {
                let size = app.sizes[key];
                if (size.progress > 0) {
                    if (size.progress >= maxProgress) {
                        maxProgress = size.progress;
                        result = size.name;
                    }
                    var percent = (size.progress / (Object.keys(app.users).length)) * 100;
                    Vue.set(app.sizes, size.name, { name: size.name, color: size.color, progress: percent });
                }
            })

            this.store.commit("setTicketResult", result);
        })
    }
    Vue.component('modal', {
        template: '#modal-template',
        store,
        data: function () {
            return { error: false };
        },
        props: ['sizes', 'baseUrl', 'roomCode', 'regex'],
        methods: {
            show: function () {
                $('#myModal').modal('show');
            },
            hide: function () {
                $('#myModal').modal('hide');
            },
            updateRoomCode: function (value) {
                this.$store.commit('setRoomCode', value);
            },
            updateBaseUrl: function (value) {
                this.$store.commit('setBaseUrl', value);
            },
            updateRegex: function (value) {
                this.$store.commit('setRegex', value);
            },
            joinRoom: function () {
                socket.emit('room chef', this.$store.state.roomCode);
                this.$store.commit('setBaseUrl', this.baseUrl);
                if (this.$store.state.tickets.length > 0) {
                    this.$store.commit('setAppState', "join");
                    this.$store.commit('firstTicket');
                    this.error = false;
                } else {
                    this.error = true;
                    this.$store.commit('setAppState', "setup");
                }
            },
            saveInLocalStorage: function () {
                localStorage.setItem('regex', this.$store.state.regex);
                localStorage.setItem('baseUrl', this.$store.state.baseUrl);
            },
            updateTickets: function (value) {
                const regex = new RegExp(this.$store.state.regex, "g");
                let tickets = [];
                while ((m = regex.exec(value)) !== null) {
                    // This is necessary to avoid infinite loops with zero-width matches
                    if (m.index === regex.lastIndex) {
                        regex.lastIndex++;
                    }

                    tickets.push({ id: m[1], title: m[2], vote: 0 });
                }
                /*
                values.forEach((value) => {
                    let v = value;
                    if (value.includes(" - ")) {
                        let ticketData = v.split(" - ")
                        tickets.push({ id: ticketData[0], title: ticketData[1], vote: 0 });
                    } else {
                        tickets.push({ id: v, title: v, vote: 0 });
                    }

                })*/
                this.$store.commit('setTickets', tickets);
            }
        },
        computed: {
            ticketString: function () {
                if (this.$store.state.tickets.length > 0) {
                    let tickets = this.$store.state.tickets;
                    return tickets.map((ticket) => {
                        return `${ticket.id} ${ticket.title}`;
                    }).join(', ');
                } else {
                    return "";
                }
            },
            state: function () {
                return this.$store.state.appState;
            }
        },
        watch: {
            state: function (state) {
                if (state === "setup") {
                    this.show();
                } else if (state === "join") {
                    this.hide();
                }
            }
        },
        mounted() {
            if (this.$store.state.appState === "setup") {
                this.show();
            }
        }
    })

    Vue.component('progress-bar', {
        template: '#progress-bar-template',
        store,
        props: ['name', 'color', 'progress', 'state'],
        methods: {
            reset: function () {
                this.progress = 0;
            }
        },
        computed: {
            trimProgress: function () {
                return Number((this.progress).toFixed(1));
            }
        }
    })

    Vue.component('reveal-button', {
        template: '#reveal-button-template',
        store,
        props: ['usersConnected', 'usersVoted'],
        methods: {
            reveal: function () {
                if (this.enabled) {
                    this.$store.commit('setAppState', "revealed")
                    app.$emit('revealVotes');
                }
            }
        },
        computed: {
            enabled: function () {
                if (this.$store.state.appState === "can_reveal") return true;
            }
        }
    })

    Vue.component('next-button', {
        template: '#next-button-template',
        store,
        methods: {
            next: function () {
                this.$store.commit('setAppState', "reset")
            }
        },
        computed: {
            enabled: function () {
                if (this.$store.state.appState === "revealed" && this.$store.state.activeTicketIndex < this.$store.state.tickets.length - 1) return true;
            }
        }
    })

    Vue.component('export-button', {
        template: '#export-button-template',
        store,
        methods: {
            xport: function () {
                var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.$store.state.tickets));
                var dlAnchorElem = document.getElementById('exportAnchor');
                dlAnchorElem.setAttribute("href", dataStr);
                dlAnchorElem.setAttribute("download", "scene.json");
                dlAnchorElem.click();
            }
        },
        computed: {
            enabled: function () {
                if (this.$store.state.appState === "revealed") return true;
            }
        }
    })

    Vue.component('reschaetz-button', {
        template: '#reschaetz-button-template',
        store,
        methods: {
            next: function () {
                this.$store.commit('setAppState', "reschaetz")
            }
        },
        computed: {
            enabled: function () {
                if (this.$store.state.appState === "revealed") return true;
            }
        }
    })

    Vue.component('user', {
        template: '#user-template',
        store,
        props: {
            name: String,
            emoji: String,
            value: String,
            voted: Boolean,
            showVotes: Boolean
        }
    })

    Vue.component('user-progress-bar', {
        template: '#user-progress-bar-template',
        store,
        data: function () {
            return {
                color: "grey",
                text: "Waiting"
            }
        },
        props: ['progress'],
        computed: {
            progressValue: function () {
                if (this.$store.state.usersVoted === 0) {
                    this.color = "grey";
                    this.text = "Waiting";
                    return 100;
                } else {
                    this.color = "green";
                    this.text = "Users Voted";
                    return (this.$store.state.usersVoted / this.$store.state.usersConnected) * 100;
                }

            }
        }
    })

    Vue.component('ticket', {
        template: '#ticket-template',
        store,
        props: ['baseUrl', 'id', 'vote', 'activeTicket', 'result', 'title'],
        computed: {
            url: function () {
                return this.baseUrl + this.id
            },
            isActive: function () {
                return this.$store.state.activeTicket.id == this.id
            }
        }
    })
</script>

<script type="text/x-template" id="ticket-template">
    <li class="list-group-item" v-bind:class="{ 'list-group-item-primary': isActive }">
        <a v-bind:href='url' target="_blank">{{ id }} - {{ title }} <span v-if='result !== ""' class="badge badge-primary float-right">{{ result }}</span></a>
    </li>
</script>

<script type="text/x-template" id="progress-bar-template">
    <!--v-if='this.$store.state.appState === "revealed"'-->
    <li class="list-group-item">
        <p> {{ name }} - {{ trimProgress }}% </p>
        <div class="progress progress-striped active progress-adjust">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" v-bind:style="{'width': progress + '%', 'background-color': color}"></div>
        </div>
    </li>
    <!--<div v-if="progress > 0" class="progress" style="height: 50px">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" v-bind:style="{'width': progress + '%', 'background-color': color}">
            <div>{{ name }} - {{ progress }}%</div>
        </div>
    </div>-->
</script>

<script type="text/x-template" id="user-progress-bar-template">
    <div class="p-4">
        <div class="progress progress-striped active progress-adjust">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" v-bind:style="{'width': progressValue + '%', 'background-color': color}">{{text}}</div>
        </div>
    </div>
</script>

<script type="text/x-template" id="user-template">
    <li class="list-group-item">
        {{ emoji }} {{ name }} 
        
        <template v-if="voted">
            <span><i class="fas fa-check-circle float-right" style="color: green;"></i></span>
        </template>
        <template v-if="!voted">
            <span><i class="fas fa-times-circle float-right" style="color: red;"></i></span>
        </template>
        <em v-if='this.$store.state.appState === "revealed"' class="float-right pr-2">
            <span class="badge badge-secondary">{{ value }}</span>
        </em>
    </li>
</script>

<script type="text/x-template" id="reveal-button-template">
    <button v-on:click="reveal" type="button" class="btn btn-success float-right" v-bind:class="{ 'disabled': !enabled }">Reveal</button>
</script>

<script type="text/x-template" id="export-button-template">
    <button id="exportBtn" v-on:click="xport" type="button" class="btn btn-success float-right">Export<a id="exportAnchor" style="display: none;"></a></button>
    
</script>

<script type="text/x-template" id="next-button-template">
    <button v-on:click="next" type="button" class="btn btn-success float-right" v-bind:class="{ 'disabled': !enabled }">Next</button>
</script>

<script type="text/x-template" id="reschaetz-button-template">
    <button v-on:click="next" type="button" class="btn btn-warning float-right" v-bind:class="{ 'disabled': !enabled }">Reschaetz</button>
</script>

<script type="text/x-template" id="modal-template">
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Room Settings</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" role="form" id="settingsForm">
                    <div class="form-group">
                        <label class="col-sm-10 control-label" for="inputUrl">Room Code</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="inputUrl" placeholder="Room Code" v-bind:value="roomCode" v-on:blur="updateRoomCode($event.target.value)"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-10 control-label" for="inputUrl">Base-Url</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="inputUrl" placeholder="Base-Url (for tickets)" v-bind:value="baseUrl" v-on:blur="updateBaseUrl($event.target.value)"/>
                        </div>
                    </div>
                    <div class=" form-group ">
                            <label class="col-sm-10 control-label " for="inputRegex ">Regex e.g. (ID-\d*) ([\w\s\\\/\-\:]*),?</label>
                            <div class="col-sm-10 ">
                                <input type="text " class="form-control " id="inputRegex" placeholder="Regex (to split tickets)" v-bind:value="regex" v-on:blur="updateRegex($event.target.value)"/>
                            </div>
                        </div>
                    <div class=" form-group">
                        <label class="col-sm-10 control-label " for="inputTickets ">Tickets</label>
                        <div class="col-sm-10 ">
                            <input type="text " class="form-control" v-bind:class="{ 'form-control-error': error }" id="inputTickets" placeholder="Tickets (comma-separated)" v-bind:value="ticketString" v-on:blur="updateTickets($event.target.value)"/>
                        </div>
                    </div>

                    <!--<div class="form-group ">
                        <label class="col-sm-2 control-label " for="inputSizes ">Sizes</label>
                        <div class="col-sm-10 ">
                            <input type="text " class="form-control " id="inputSizes " placeholder="Ticket Sizes (comma-separated) " v-bind:value="sizes"/>
                        </div>
                    </div> -->
                </form>
            </div>
            <div class="modal-footer ">
                <button type="button" class="btn btn-success" v-on:click="saveInLocalStorage">Save</button>
                <button type="button" class="btn btn-success" v-on:click="joinRoom">Join Room</button>
            </div>
        </div>
    </div>
</div>
</div>
</script>